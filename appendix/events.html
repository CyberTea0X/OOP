<!DOCTYPE HTML>
<html lang="en" class="sidebar-visible no-js light">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>События и их обработчики - ООП практические работы 5-8</title>


        <!-- Custom HTML head -->
        
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

        <link rel="icon" href="../favicon.svg">
        <link rel="shortcut icon" href="../favicon.png">
        <link rel="stylesheet" href="../css/variables.css">
        <link rel="stylesheet" href="../css/general.css">
        <link rel="stylesheet" href="../css/chrome.css">
        <link rel="stylesheet" href="../css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="../FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="../fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="../highlight.css">
        <link rel="stylesheet" href="../tomorrow-night.css">
        <link rel="stylesheet" href="../ayu-highlight.css">

        <!-- Custom theme stylesheets -->

    </head>
    <body>
    <div id="body-container">
        <!-- Provide site root to javascript -->
        <script>
            var path_to_root = "../";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('no-js')
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add('js');
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            var html = document.querySelector('html');
            var sidebar = null;
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            } else {
                sidebar = 'hidden';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item expanded "><a href="../intro.html"><strong aria-hidden="true">1.</strong> Введение</a></li><li class="chapter-item expanded "><a href="../practices/pr5/p5.html"><strong aria-hidden="true">2.</strong> Практическая работа №5</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../practices/pr5/key_concepts.html"><strong aria-hidden="true">2.1.</strong> Ключевые понятия</a></li><li class="chapter-item expanded "><a href="../practices/pr5/task1.html"><strong aria-hidden="true">2.2.</strong> Задание 1. Использование интерфейсов</a></li><li class="chapter-item expanded "><a href="../practices/pr5/task2.html"><strong aria-hidden="true">2.3.</strong> Задание 2. Создание абстрактного класса</a></li><li class="chapter-item expanded "><a href="../practices/pr5/task3.html"><strong aria-hidden="true">2.4.</strong> Задание 3. Создание архитектуры приложения с помощью интерфейсов</a></li></ol></li><li class="chapter-item expanded "><a href="../practices/pr6/p6.html"><strong aria-hidden="true">3.</strong> Практическая работа №6</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../practices/pr6/key_concepts.html"><strong aria-hidden="true">3.1.</strong> Ключевые понятия</a></li><li class="chapter-item expanded "><a href="../practices/pr6/task1.html"><strong aria-hidden="true">3.2.</strong> Задание 1. Использование событий (в разработке)</a></li></ol></li><li class="chapter-item expanded "><a href="../appendix/page.html"><strong aria-hidden="true">4.</strong> Приложение</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../appendix/vs_hotkeys.html"><strong aria-hidden="true">4.1.</strong> Visual studio хоткеи</a></li><li class="chapter-item expanded "><a href="../appendix/interfaces.html"><strong aria-hidden="true">4.2.</strong> Интерфейсы</a></li><li class="chapter-item expanded "><a href="../appendix/abstract_class.html"><strong aria-hidden="true">4.3.</strong> Абстрактный класс</a></li><li class="chapter-item expanded "><a href="../appendix/multiple_interface_inherit.html"><strong aria-hidden="true">4.4.</strong> Множественное наследование</a></li><li class="chapter-item expanded "><a href="../appendix/explicit_interfaces.html"><strong aria-hidden="true">4.5.</strong> Явная реализация интерфейсов</a></li><li class="chapter-item expanded "><a href="../appendix/abstract_classes_vs_interfaces.html"><strong aria-hidden="true">4.6.</strong> Абстрактные классы vs интерфейсы</a></li><li class="chapter-item expanded "><a href="../appendix/intefaces_and_abstract_classes_in_app_design.html"><strong aria-hidden="true">4.7.</strong> Справка по проектированию с использованием абстрактных классов и интерфейсов</a></li><li class="chapter-item expanded "><a href="../appendix/delegate.html"><strong aria-hidden="true">4.8.</strong> Делегаты</a></li><li class="chapter-item expanded "><a href="../appendix/lambda.html"><strong aria-hidden="true">4.9.</strong> Лямбда выражения</a></li><li class="chapter-item expanded "><a href="../appendix/events.html" class="active"><strong aria-hidden="true">4.10.</strong> События и их обработчики</a></li><li class="chapter-item expanded "><a href="../appendix/dot_net_events.html"><strong aria-hidden="true">4.11.</strong> Модель событий .NET Framework</a></li></ol></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky bordered">
                    <div class="left-buttons">
                        <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </button>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">ООП практические работы 5-8</h1>

                    <div class="right-buttons">
                        <a href="../print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="События-и-их-обработчики"><a class="header" href="#События-и-их-обработчики">События и их обработчики</a></h1>
<h2 id="Определение-и-вызов-событий"><a class="header" href="#Определение-и-вызов-событий">Определение и вызов событий</a></h2>
<p>События — это особый вид многоадресного делегата, который может вызываться только из класса (или производных классов) или структуры, где они объявлены (класс издателя).</p>
<p>События объявляются в классе с помощью ключевого слова <code>event</code>, после которого указывается тип делегата, который представляет событие:</p>
<pre><code class="language-C#">delegate void AccountHandler(string message);
event AccountHandler Notify;
</code></pre>
<p>В данном случае вначале определяется делегат <code>AccountHandler</code>, который принимает один параметр типа <code>string</code>. Затем с помощью ключевого слова <code>event</code> определяется событие с именем <code>Notify</code>, которое представляет делегат <code>AccountHandler</code>. Название для события может быть произвольным, но в любом случае оно должно представлять некоторый делегат.</p>
<p>Определив событие, мы можем его вызвать в программе как метод, используя имя события:</p>
<pre><code class="language-C#">Notify(&quot;Произошло действие&quot;);
</code></pre>
<p>Поскольку событие <code>Notify</code> представляет делегат <code>AccountHandler</code>, который принимает один параметр типа <code>string</code> - строку, то при вызове события нам надо передать в него строку.</p>
<p>Однако при вызове событий мы можем столкнуться с тем, что событие равно <code>null</code> в случае, если для его не определен обработчик. Поэтому при вызове события лучше его всегда проверять на <code>null</code>. Например, так:</p>
<pre><code class="language-C#">Notify?.Invoke(&quot;Произошло действие&quot;);
</code></pre>
<p>В этом случае поскольку событие представляет делегат, то мы можем его вызвать с помощью метода <a href="./delegate.html#%D0%9C%D0%B5%D1%82%D0%BE%D0%B4-invoke">Invoke()</a>, передав в него необходимые значения для параметров.</p>
<p>Создадим и вызовем событие:</p>
<pre><code class="language-C#">class Account
{
    // В делегате определяем как будет выглядеть наше событие
    public delegate void AccountHandler(string message);

    // 1. Определение события
    public event AccountHandler? Notify;

    // Конструктор через лямбда выражение
    public Account(int sum) =&gt; Sum = sum;

    public int Sum { get; private set; }

    public void Put(int sum)
    {
        Sum += sum;
        Notify?.Invoke($&quot;На счет поступило: {sum}&quot;);   // 2.Вызов события 
    }

    public void Take(int sum)
    {
        if (Sum &gt;= sum)
        {
            Sum -= sum;
            Notify?.Invoke($&quot;Со счета снято: {sum}&quot;);   // 2.Вызов события
        }
        else
        {
            Notify?.Invoke($&quot;Недостаточно денег на счету. Текущий баланс: {Sum}&quot;); ;
        }
    }
}
</code></pre>
<h2 id="Добавление-обработчика-события"><a class="header" href="#Добавление-обработчика-события">Добавление обработчика события</a></h2>
<p>С событием может быть связан один или несколько обработчиков. Обработчики событий - это именно то, что выполняется при вызове событий. Нередко в качестве обработчиков событий применяются методы. Каждый обработчик событий по списку параметров и возвращаемому типу должен соответствовать делегату, который представляет событие. Для добавления обработчика события применяется операция +=:</p>
<p>Определим обработчики для события <code>Notify</code>, чтобы получить в программе нужные уведомления:</p>
<pre><code class="language-C#">void DisplayMessage(string message) =&gt; Console.WriteLine(message);
Account account = new Account(100);
account.Notify += DisplayMessage;   // Добавляем обработчик для события Notify

account.Put(20);    // добавляем на счет 20
// Наш обработчик перехватит событие, произошедшее в методе account.Put и выведет: На счет поступило: 20
</code></pre>
<p>При вызове события <code>Notify?.Invoke()</code> будет вызываться метод <code>DisplayMessage</code>, которому для параметра message будет передаваться строка, которая передается в <code>Notify?.Invoke()</code>. В <code>DisplayMessage</code> просто выводим полученное от события сообщение, но можно было бы определить любую логику.</p>
<p>Если бы в данном случае обработчик не был бы установлен, то при вызове события <code>Notify?.Invoke()</code> ничего не происходило, так как событие <code>Notify</code> было бы равно <code>null</code>.</p>
<h2 id="Добавление-и-удаление-обработчиков"><a class="header" href="#Добавление-и-удаление-обработчиков">Добавление и удаление обработчиков</a></h2>
<p>Для одного события можно установить несколько обработчиков и потом в любой момент времени их удалить.</p>
<pre><code class="language-C#">void DisplayMessage(string message) =&gt; Console.WriteLine(message);
void DisplayBoldMessage(string message) =&gt; Console.WriteLine($&quot;**{message}**&quot;);

Account account = new Account(100);
account.Notify += DisplayMessage;       // добавляем обработчик DisplayMessage
account.Notify += DisplayBoldMessage;    // добавляем обработчик DisplayRedMessage
account.Put(20);    // добавляем на счет 20
account.Notify -= DisplayBoldMessage;     // удаляем обработчик DisplayRedMessage
account.Put(50);    // добавляем на счет 50
</code></pre>
<pre><code class="language-console">На счет поступило: 20
**На счет поступило: 20**
На счет поступило: 50
</code></pre>
<p>В качестве обработчиков могут использоваться не только обычные методы, но также делегаты, анонимные методы и лямбда-выражения:</p>
<pre><code class="language-C#">void DisplayMessage(string message) =&gt; Console.WriteLine(message);

Account acc = new Account(100);
// установка делегата, который указывает на метод DisplayMessage
acc.Notify += new Account.AccountHandler(DisplayMessage);
// установка в качестве обработчика метода DisplayMessage
acc.Notify += DisplayMessage;       // добавляем обработчик DisplayMessage
 
acc.Put(20);    // добавляем на счет 20
</code></pre>
<p>В данном случае разницы между двумя обработчиками никакой не будет.</p>
<p>Установка в качестве обработчика анонимного метода:</p>
<pre><code class="language-C#">Account acc = new Account(100);
acc.Notify += delegate (string mes)
{
    Console.WriteLine(mes);
};
acc.Put(20);
</code></pre>
<p>Установка в качестве обработчика лямбда-выражения:</p>
<pre><code class="language-C#">Account account = new Account(100);
account.Notify += message =&gt; Console.WriteLine(message);
account.Put(20);
</code></pre>
<h2 id="Управление-обработчиками"><a class="header" href="#Управление-обработчиками">Управление обработчиками</a></h2>
<p>С помощью специальных акссесоров <code>add</code>/<code>remove</code> мы можем управлять добавлением и удалением обработчиков. Как правило, подобная функциональность редко требуется, но тем не менее мы ее можем использовать. Например:</p>
<pre><code class="language-C#">class Account
{
    public delegate void AccountHandler(string message);
    AccountHandler? notify;
    public event AccountHandler Notify
    {
        add
        {
            notify += value;
            Console.WriteLine($&quot;{value.Method.Name} добавлен&quot;);
        }
        remove
        {
            notify -= value;
            Console.WriteLine($&quot;{value.Method.Name} удален&quot;);
        }
    }
    public Account(int sum) =&gt; Sum = sum;
    public int Sum { get; private set; }
    public void Put(int sum)
    {
        Sum += sum;
        notify?.Invoke($&quot;На счет поступило: {sum}&quot;);   // 2.Вызов события 
    }
    public void Take(int sum)
    {
        if (Sum &gt;= sum)
        {
            Sum -= sum;
            notify?.Invoke($&quot;Со счета снято: {sum}&quot;);   // 2.Вызов события
        }
        else
        {
            notify?.Invoke($&quot;Недостаточно денег на счете. Текущий баланс: {Sum}&quot;); ;
        }
    }
}
</code></pre>
<p>Теперь опредление события разбивается на две части. Вначале просто определяется переменная делегата, через которую мы можем вызывать связанные обработчики:</p>
<pre><code class="language-C#">AccountHandler notify;
</code></pre>
<p>Во второй части определяем акссесоры <code>add</code> и <code>remove</code>. Аксессор <code>add</code> вызывается при добавлении обработчика, то есть при операции +=. Добавляемый обработчик доступен через ключевое слово <code>value</code>. Здесь мы можем получить информацию об обработчике (например, имя метода через <code>value.Method.Name</code>) и определить некоторую логику. В данном случае для простоты просто выводится сообщение на консоль:</p>
<pre><code class="language-C#">add
{
    notify += value;
    Console.WriteLine($&quot;{value.Method.Name} добавлен&quot;);
}
</code></pre>
<p>Блок <code>remove</code> вызывается при удалении обработчика. Аналогично здесь можно задать некоторую дополнительную логику:</p>
<pre><code class="language-C#">remove
{
    notify -= value;
    Console.WriteLine($&quot;{value.Method.Name} удален&quot;);
}
</code></pre>
<p>Внутри класса событие вызывается также через переменную <code>notify</code>. Но для добавления и удаления обработчиков в программе используется как раз <code>Notify</code>:</p>
<pre><code class="language-C#">Account acc = new Account(100);
acc.Notify += DisplayMessage;       // добавляем обработчик DisplayMessage
acc.Put(20);    // добавляем на счет 20
acc.Notify -= DisplayMessage;     // удаляем обработчик DisplayMessage
acc.Put(20);    // добавляем на счет 20
 
void DisplayMessage(string message) =&gt; Console.WriteLine(message);
</code></pre>
<p>Консольный вывод программы:</p>
<pre><code class="language-console">DisplayMessage добавлен
На счет поступило: 20
DisplayMessage удален
</code></pre>
<h2 id="Передача-данных-события"><a class="header" href="#Передача-данных-события">Передача данных события</a></h2>
<p>Помимо простой строки, через событие можно передавать вообще любые данные.
Полученный урон в игре, нажатую клавишу, кнопку в интерфейсе и т.п.</p>
<h2 id="Утечки-памяти-при-работе-с-событиями"><a class="header" href="#Утечки-памяти-при-работе-с-событиями">Утечки памяти при работе с событиями</a></h2>
<p>При подписке на событие мы добавляем в список вызовов делегата события ссылку на метод, который будет вызван при вызове события. Таким образом, память, занимаемая объектом, подписавшимся на событие, не будет освобождена до его отписки от события или до уничтожения объекта, заключающего в себе событие. Эта особенность является одной из часто встречаемых причин утечек памяти в приложениях.</p>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="../appendix/lambda.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>

                            <a rel="next" href="../appendix/dot_net_events.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="../appendix/lambda.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>

                    <a rel="next" href="../appendix/dot_net_events.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>




        <script>
            window.playground_copyable = true;
        </script>


        <script src="../elasticlunr.min.js"></script>
        <script src="../mark.min.js"></script>
        <script src="../searcher.js"></script>

        <script src="../clipboard.min.js"></script>
        <script src="../highlight.js"></script>
        <script src="../book.js"></script>

        <!-- Custom JS scripts -->


    </div>
    </body>
</html>
